<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crazy Multi-Widget Demo</title>
  <script type="module">
    import { h, render, Component } from 'https://esm.sh/preact';
    import htm from 'https://esm.sh/htm';
    const html = htm.bind(h);

    class CrazyWidget extends Component {
      state = { isOpen: false, messages: [] };

      toggle = () => {
        this.setState({ isOpen: !this.state.isOpen });
        if (!this.state.isOpen && this.state.messages.length === 0) {
          this.setState({ messages: [{ text: 'Hello from demo Widget!', sender: 'bot' }] });
        }
      };

      send = (e) => {
        e.preventDefault();
        const input = e.target.querySelector('input');
        const txt = input.value.trim();
        if (!txt) return;
        this.setState({ messages: [...this.state.messages, { text: txt, sender: 'user' }] });
        input.value = '';
        setTimeout(() => {
          this.setState({
            messages: [...this.state.messages, { text: 'ðŸ¦„ You said: ' + txt, sender: 'bot' }]
          });
        }, 700);
      };

      componentDidUpdate() {
        if (this.btn) {
          this.btn.style.animation = 'wiggle 0.8s ease-in-out';
          this.btn.addEventListener('animationend', () => this.btn.style.animation = '', { once:true });
        }
      }

      render() {
        const { isOpen, messages } = this.state;
        const { emoji, color, title, pos } = this.props;
        return html`
          <div style="position: fixed; ${pos}; z-index: 9999;">
            ${!isOpen && html`
              <button
                ref=${el => this.btn = el}
                onClick=${this.toggle}
                style="background:${color};color:white;border:none;border-radius:50%;width:60px;height:60px;font-size:28px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);"
              >${emoji}</button>
            `}
            ${isOpen && html`
              <div style="background:white;width:360px;height:520px;border-radius:12px;box-shadow:0 12px 36px rgba(0,0,0,0.3);display:flex;flex-direction:column;overflow:hidden;animation:fadeIn 0.3s ease;">
                <div style="background:${color};color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                  <div style="font-weight:600;font-size:18px;">${emoji} ${title}</div>
                  <button onClick=${this.toggle} style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">Ã—</button>
                </div>
                <div id="msgs" style="flex:1;padding:20px;overflow-y:auto;background:#f0f0f0;">
                  ${messages.map(m => html`
                    <div style="margin-bottom:12px;display:flex;justify-content:${m.sender==='bot'?'flex-start':'flex-end'};">
                      <div style="max-width:80%;padding:10px 14px;border-radius:12px;background:${m.sender==='bot'?'white':color};color:${m.sender==='bot'?'#333':'white'};box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                        ${m.text}
                      </div>
                    </div>
                  `)}
                </div>
                <form onSubmit=${this.send} style="padding:15px;border-top:1px solid #ddd;display:flex;gap:10px;background:white;">
                  <input type="text" placeholder="Type..." style="flex:1;padding:10px;border:1px solid #ccc;border-radius:20px;outline:none;" />
                  <button type="submit" style="background:${color};color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-weight:600;">Send</button>
                </form>
              </div>
            `}
          </div>
        `;
      }
    }

    render(html`
      <${CrazyWidget} emoji="ðŸ’¬" color="#007bff" title="Chat" pos="bottom:20px;right:20px;" />
      <${CrazyWidget} emoji="ðŸ“©" color="#28a745" title="Contact" pos="bottom:20px;right:100px;" />
      <${CrazyWidget} emoji="ðŸš€" color="#ff5722" title="Launch" pos="bottom:20px;center:50%;transform:translateX(-50%);" />
    `, document.body);
  </script>
  <style>
    @keyframes wiggle {
      0%,100%{transform:rotate(0deg);}
      15%{transform:rotate(-5deg);}
      30%{transform:rotate(5deg);}
      45%{transform:rotate(-5deg);}
      60%{transform:rotate(5deg);}
    }
    @keyframes fadeIn {
      from{opacity:0;transform:scale(0.9);}
      to{opacity:1;transform:scale(1);}
    }
  </style>
</head>
<body>
  <h1> Widgets</h1>
  <p>Three independent widgets using Preact with wiggle, fade, and custom positions!</p>
</body>
</html>
